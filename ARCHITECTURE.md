# 风琴五笔输入法架构设计文档

## 项目概述

风琴五笔输入法是一款基于Windows系统的中文输入法，支持多种输入方式，提供丰富的功能，包括词库管理、模糊音处理、历史记录、用户配置和Windows TSF接口支持等。

## 整体架构

项目采用多语言混合开发架构，主要包括以下组件：

1. **核心库 (C++)**：实现基础输入逻辑、词库管理和Windows TSF接口
2. **UI界面 (C#)**：实现用户交互界面、设置面板和配置管理界面
3. **词库算法 (F#)**：实现高效的词库搜索、模糊音处理和历史记录管理算法
4. **配置管理 (F#)**：实现配置数据的存储、读取和应用
5. **构建工具**：提供批处理脚本简化项目构建和运行流程

## 组件关系

```
┌─────────────────────────────────────────────────────────────────┐
│                     用户界面层 (C#)                            │
│  ┌───────────────┐  ┌───────────────┐  ┌────────────────────┐  │
│  │  输入法窗口   │  │   设置面板    │  │    功能控制区     │  │
│  └───────────────┘  └───────────────┘  └────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│                     中间交互层 (C++/C#)                         │
│  ┌───────────────┐  ┌───────────────┐  ┌────────────────────┐  │
│  │  TSF接口      │  │  输入处理器   │  │    配置管理器     │  │
│  └───────────────┘  └───────────────┘  └────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│                     核心功能层 (C++/F#)                         │
│  ┌───────────────┐  ┌───────────────┐  ┌────────────────────┐  │
│  │  词库管理器   │  │  模糊音处理   │  │    历史记录管理   │  │
│  └───────────────┘  └───────────────┘  └────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│                     数据存储层                                  │
│  ┌───────────────┐  ┌───────────────┐  ┌────────────────────┐  │
│  │  系统词库文件 │  │  用户词库文件 │  │    配置文件       │  │
│  └───────────────┘  └───────────────┘  └────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 技术选型

1. **C++**：使用TSF接口实现系统级输入法功能
2. **C#**：使用Windows Forms实现用户界面
3. **F#**：使用函数式编程实现高效的词库搜索算法
4. **CMake**：用于C++项目的构建管理

## 主要功能模块

### 1. 输入处理模块

- 编码输入处理
- 候选词生成和管理
- 数字键选择候选词
- 空格键显示候选词
- Enter键确认输入
- ESC键清除输入

### 2. 词库管理模块

- 系统词库加载
- 用户词库管理
- 词库切换功能
- 新词添加功能
- 编码查找和匹配

### 3. 模糊音处理模块

- 模糊音映射表定义
- 编码变体生成
- 模糊音开关控制
- 常见模糊音支持（平翘舌、前后鼻音等）

### 4. 历史记录管理模块

- 用户输入记录
- 使用频率统计
- 候选词智能排序
- 历史记录开关控制
- 记录数量和使用次数限制

### 5. 配置管理模块

- 配置文件读写
- 功能开关设置
- 快捷键自定义
- 参数配置管理
- 配置自动保存和加载

### 6. 用户界面模块

- 输入法窗口
- 设置面板
- 功能控制区（模糊音开关、历史记录开关等）
- 状态栏显示
- 无边框窗口拖动

## 跨语言交互

1. **C#调用C++**：使用P/Invoke机制调用TSF接口
2. **C#调用F#**：通过.NET程序集引用直接调用
3. **C++调用F#**：通过COM接口或C++/CLI桥接

## 目录结构

```
├── src/
│   ├── cpp/        # C++ TSF接口实现
│   ├── csharp/     # C# UI界面实现
│   ├── fsharp/     # F#词库算法实现
│   └── shared/     # 共享代码和资源
├── data/           # 词库文件
├── skins/          # 皮肤文件
├── docs/           # 文档
├── build/          # 构建输出目录
└── third_party/    # 第三方库
```

## 构建流程

1. 使用CMake构建C++ TSF接口库
2. 使用dotnet build构建C#和F#项目
3. 将构建结果复制到输出目录
4. 注册TSF输入法组件

## 后续开发计划

1. 完成核心输入功能实现
2. 开发多皮肤支持系统
3. 实现词库管理功能
4. 开发设置面板
5. 优化用户体验

## 注意事项

1. 确保所有组件遵循统一的命名规范
2. 保持代码的可维护性和可扩展性
3. 确保多语言组件之间的正确交互
4. 遵循Windows输入法开发的最佳实践